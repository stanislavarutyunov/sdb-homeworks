# Домашнее задание к занятию 12.09. «Базы данных в облаке»

**Домашнее задание выполните в Google Docs или в md-файле в вашем репозитории GitHub.** 

Для оформления вашего решения в GitHub можете воспользоваться [шаблоном](https://github.com/netology-code/sys-pattern-homework).

Название файла Google Docs должно содержать номер лекции и фамилию студента. Пример названия: «12.9. Базы данных в облаке — Александр Александров».

Перед тем как выслать ссылку, убедитесь, что её содержимое не является приватным, то есть открыто на просмотр всем, у кого есть ссылка. Если необходимо прикрепить дополнительные ссылки, просто добавьте их в свой Google Docs.

Любые вопросы по решению задач задавайте в чате учебной группы.


---

Домашнее задание подразумевает, что вы уже делали предыдущие работы в Яндекс.Облаке, и у вас есть аккаунт и каталог.


Используйте следующие рекомендации во избежание лишних трат в Яндекс.Облаке:
1) Сразу после выполнения задания удалите кластер.
2) Если вы решили взять паузу на выполнение задания, то остановите кластер.

### Задание 1


#### Создание кластера
1. Перейдите на главную страницу сервиса Managed Service for PostgreSQL.
1. Создайте кластер PostgreSQL со следующими параметрами:
- класс хоста: s2.micro, диск network-ssd любого размера;
- хосты: нужно создать два хоста в двух разных зонах доступности и указать необходимость публичного доступа, то есть публичного IP адреса, для них;
- установите учётную запись для пользователя и базы.

Остальные параметры оставьте по умолчанию либо измените по своему усмотрению.

* Нажмите кнопку «Создать кластер» и дождитесь окончания процесса создания, статус кластера = RUNNING. Кластер создаётся от 5 до 10 минут.
 
 ![Снимок экрана от 2023-04-04 11-07-34](https://user-images.githubusercontent.com/119142863/229836343-351d9631-7def-4b76-8483-079c3fe52c6c.png)

![Снимок экрана от 2023-04-04 11-08-18](https://user-images.githubusercontent.com/119142863/229836468-b41c1d1d-9f8e-4698-8734-1e67bd2145ec.png)


#### Подключение к мастеру и реплике 

* Используйте инструкцию по подключению к кластеру, доступную на вкладке «Обзор»: cкачайте SSL-сертификат и подключитесь к кластеру с помощью утилиты psql, указав hostname всех узлов и атрибут ```target_session_attrs=read-write```.

Получаем SSL-сертификат:

![image](https://user-images.githubusercontent.com/119142863/229837213-2d491415-47db-4404-89ed-e1fe4a6c80ee.png)

Определим хост, на котором мастер:

![image](https://user-images.githubusercontent.com/119142863/229842271-03e2a11d-1692-435e-956c-1a1c168fc062.png)

Получаем команду:

![image](https://user-images.githubusercontent.com/119142863/229850361-278ff9cf-bf1c-4983-9509-850a1485302d.png)

Подключаемся:
  
![image](https://user-images.githubusercontent.com/119142863/229850261-fd5cce05-f531-46ca-86cc-4fa9fd3f388d.png)


* Проверьте, что подключение прошло к master-узлу.
```
select case when pg_is_in_recovery() then 'REPLICA' else 'MASTER' end;
```
* Посмотрите количество подключенных реплик:
```
select count(*) from pg_stat_replication;
```
![image](https://user-images.githubusercontent.com/119142863/229850603-ed9f62c9-20fd-4106-8b04-c4d9f9989576.png)


### Проверьте работоспособность репликации в кластере

* Создайте таблицу и вставьте одну-две строки.
```
CREATE TABLE test_table(text varchar);
```
```
insert into test_table values('Строка 1');
```
![image](https://user-images.githubusercontent.com/119142863/229850888-724e250a-6f1b-43cb-9046-dccc34b28389.png)


* Выйдите из psql командой ```\q```.

* Теперь подключитесь к узлу-реплике. Для этого из команды подключения удалите атрибут ```target_session_attrs```  и в параметре атрибут ```host``` передайте только имя хоста-реплики. Роли хостов можно посмотреть на соответствующей вкладке UI консоли.


* Проверьте, что подключение прошло к узлу-реплике.
```
select case when pg_is_in_recovery() then 'REPLICA' else 'MASTER' end;
```
![image](https://user-images.githubusercontent.com/119142863/229851366-3a7680f3-2b53-4d92-acd1-c51dd9938ce4.png)


* Проверьте состояние репликации
```
select status from pg_stat_wal_receiver;
```
![image](https://user-images.githubusercontent.com/119142863/229851542-caa7598f-b555-4c5c-8619-bc941de102d2.png)


* Для проверки, что механизм репликации данных работает между зонами доступности облака, выполните запрос к таблице, созданной на предыдущем шаге:
```
select * from test_table;
```
![image](https://user-images.githubusercontent.com/119142863/229851679-ee6940de-53be-44a7-91dd-0aa31f251530.png)

*В качестве результата вашей работы пришлите скриншоты:*

*1) Созданной базы данных;*
*2) Результата вывода команды на реплике ```select * from test_table;```.*



### Задание 2*

Создайте кластер, как в задании 1 с помощью Terraform.


*В качестве результата вашей работы пришлите скришоты:*

*1) Скриншот созданной базы данных.*
*2) Код Terraform, создающий базу данных.*

---

Задания, помеченные звёздочкой, — дополнительные, то есть не обязательные к выполнению, и никак не повлияют на получение вами зачёта по этому домашнему заданию. Вы можете их выполнить, если хотите глубже шире разобраться в материале.
